version: 2.1

jobs:
  run-tests:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo rm -rf /var/lib/apt/lists/*
            export FORCED_ROOT=1
            sudo -E -H ./uncertain.sh install
            ./uncertain.sh configure
      - run:
          name: Run tests and demos
          command: |
            ./uncertain.sh test
      - run:
          name: Upload coverage reports
          command: |
            export TRAVIS_JOB_ID="#${CIRCLE_BUILD_NUM}"
            ./uncertain.sh cov --upload

  static-checks:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo rm -rf /var/lib/apt/lists/*
            export FORCED_ROOT=1
            sudo -E -H ./uncertain.sh install
            ./uncertain.sh configure
      - run:
          name: Build
          command: |
            ./uncertain.sh build
      - run:
          name: Perform static checks
          command: |
            ./uncertain.sh check

workflows:
  commit:
    jobs:
      - run-tests
      - static-checks
